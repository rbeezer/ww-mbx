## ********************************************************************* ##
## Copyright 2015                                                        ##
## Robert A. Beezer, Michael Gage, Geoff Goehle, Alex Jordan             ##
##                                                                       ##
## This file is part of MathBook XML.                                    ##
##                                                                       ##
## MathBook XML is free software: you can redistribute it and/or modify  ##
## it under the terms of the GNU General Public License as published by  ##
## the Free Software Foundation, either version 2 or version 3 of the    ##
## License (at your option).                                             ##
##                                                                       ##
## MathBook XML is distributed in the hope that it will be useful,       ##
## but WITHOUT ANY WARRANTY; without even the implied warranty of        ##
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         ##
## GNU General Public License for more details.                          ##
##                                                                       ##
## You should have received a copy of the GNU General Public License     ##
## along with MathBook XML.  If not, see <http://www.gnu.org/licenses/>. ##
## ********************************************************************* ##

####################
# DO NOT EDIT THIS FILE
#######################

#   1) Do make a copy of Makefile.paths.original
#      as Makefile.paths
#   2) Edit Makefile.paths as directed there
#   3) This file (Makefile) and Makefile.paths.original
#      are managed by revision control and edits will conflict
#   4) See updated history in Makefile.paths.original
#      for changes, or follow the revision control history

##############
# Introduction
##############

# This is not a "true" makefile, since it does not
# operate on dependencies.  It is more of a shell
# script, sharing common configurations

######################
# System Prerequisites
######################

#   install         (system tool to make directories)
#   xsltproc        (xml/xsl text processor)
#   xmllint         (only to check source against DTD)
#   <helpers>       (PDF viewer, web browser, pager, Sage executable, etc)

#####
# Use
#####

#	A) Set default directory to be the location of this file
#	B) At command line:  make solutions  (and employ targets)

# The included file contains customized versions
# of locations of the principal components of this
# project and names of various helper executables
include Makefile.paths

# These paths are subdirectories of
# the Mathbook XML distribution
# MBUSR is where extension files get copied
# so relative paths work properly
# MBSCRIPT = $(MB)/script
MBXSL = $(MB)/xsl
MBUSR = $(MB)/user
WWDTD = $(WWMBX)/schema/dtd
WWXSL = $(WWMBX)/xsl

# These are source and custom XSL subdirectories
# for the two AATA repositories
# SRC = $(AATA)/src
# XSL = $(AATA)/xsl
# EXR = $(AATASOLNS)/src
# SOLNXSL = $(AATASOLNS)/xsl

# These paths are subdirectories of
# a scratch directory
PGOUT      = $(SCRATCH)/pg
HTMLOUT    = $(SCRATCH)/html
PDFOUT     = $(SCRATCH)/pdf
EPUBOUT    = $(SCRATCH)/epub

###########
# Utilities
###########

# Verify Source integrity
#   Leaves "dtderrors.txt" in SCRATCH
#   can then grep on, eg
#     "element XXX:"
#     "does not follow"
#     "Element XXXX content does not follow"
#     "No declaration for"
#   Automatically invokes the "less" pager, could configure as $(PAGER)
check-mini:
	install -d $(SCRATCH)
	-rm $(SCRATCH)/dtderrors.*
	-xmllint --xinclude --noout --dtdvalid $(WWDTD)/webwork.dtd $(WWMBX)/examples/minimal/mini.xml 2> $(SCRATCH)/dtderrors.txt
	less $(SCRATCH)/dtderrors.txt

##########
## Testing
##########

minimal:
	install -d $(PGOUT) $(MBUSR)
	-rm $(PGOUT)/*.pg
	cp $(WWXSL)/extract-webwork.xsl $(WWXSL)/webwork-pg.xsl $(MBUSR)
	cd $(PGOUT); \
	xsltproc --stringparam webwork.server https://webwork.pcc.edu $(MBUSR)/extract-webwork.xsl $(WWMBX)/examples/minimal/mini.xml

chapter:
	install -d $(PGOUT) $(MBUSR)
	#-rm $(PGOUT)/*.pg
	cp $(WWXSL)/extract-webwork.xsl $(WWXSL)/webwork-pg.xsl $(MBUSR)
	cd $(PGOUT); \
	xsltproc --stringparam webwork.server https://webwork.pcc.edu --stringparam chunk.level 1 $(MBUSR)/extract-webwork.xsl $(WWMBX)/examples/sample-chapter/sample-chapter.xml
	#
	install -d $(PDFOUT) $(MBUSR)
	-rm $(PDFOUT)/*.tex
	cp $(WWXSL)/webwork-latex.xsl $(MBUSR)
	cd $(PDFOUT); \
	xsltproc --stringparam webwork.server https://webwork.pcc.edu --stringparam toc.level 0 $(MBUSR)/webwork-latex.xsl $(WWMBX)/examples/sample-chapter/sample-chapter.xml; \
	xelatex sample-ww-chapter.tex; \
	xelatex sample-ww-chapter.tex
	#
	install -d $(HTMLOUT) $(MBUSR)
	-rm $(HTMLOUT)/*.html
	cp $(WWXSL)/webwork-pg.xsl $(WWXSL)/webwork-html.xsl $(MBUSR)
	cp -a $(WWMBX)/examples/sample-chapter/images $(HTMLOUT)
	# xslt_base64: https://github.com/ilyakharlamov/xslt_base64
	# heavily modified for MBX
	cp $(WWXSL)/xslt_base64/base64.xsl $(MBUSR)
	cp $(WWXSL)/xslt_base64/base64_binarydatamap.xml $(MBUSR)
	# --maxdepth should not be needed for divide-and-conquer recursion
	cd $(HTMLOUT); \
	xsltproc --stringparam webwork.server https://webwork.pcc.edu --stringparam html.knowl.exercise.inline no $(MBUSR)/webwork-html.xsl $(WWMBX)/examples/sample-chapter/sample-chapter.xml

templates:
	install -d $(PGOUT) $(MBUSR)
	-rm $(PGOUT)/*.pg
	cp $(WWXSL)/extract-webwork.xsl $(WWXSL)/webwork-pg.xsl $(MBUSR)
	cd $(PGOUT); \
	xsltproc --stringparam webwork.server https://webwork.pcc.edu $(MBUSR)/extract-webwork.xsl $(WWMBX)/examples/webwork-templates/webwork-templates.xml
	#
	install -d $(PDFOUT) $(MBUSR)
	-rm $(PDFOUT)/*.tex
	cp $(WWXSL)/webwork-latex.xsl $(MBUSR)
	cd $(PDFOUT); \
	xsltproc --stringparam webwork.server https://webwork.pcc.edu --stringparam toc.level 0 $(MBUSR)/webwork-latex.xsl $(WWMBX)/examples/webwork-templates/webwork-templates.xml; \
	xelatex webwork-templates.tex; \
	xelatex webwork-templates.tex
	#
	install -d $(HTMLOUT) $(MBUSR)
	-rm $(HTMLOUT)/*.html
	cp $(WWXSL)/webwork-pg.xsl $(WWXSL)/webwork-html.xsl $(MBUSR)
	cp -a $(WWMBX)/examples/webwork-templates/images $(HTMLOUT)
	# xslt_base64: https://github.com/ilyakharlamov/xslt_base64
	# recursion on entire problem content, up limits on  xsltproc
	cp $(WWXSL)/xslt_base64/base64.xsl $(MBUSR)
	cp $(WWXSL)/xslt_base64/base64_binarydatamap.xml $(MBUSR)
	cd $(HTMLOUT); \
	xsltproc --maxdepth 12000 --stringparam webwork.server https://webwork.pcc.edu --stringparam html.knowl.exercise.inline no $(MBUSR)/webwork-html.xsl $(WWMBX)/examples/webwork-templates/webwork-templates.xml
